<!DOCTYPE html>
<html>
	<head>
		<base target="_top">
		<meta charset="UTF-8" />
		<style>
			body { font-family: sans-serif; margin: 20px; }
			table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
			th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: middle; }
			input, select, textarea { width: 100%; box-sizing: border-box; }  /* â† â† ã“ã‚Œã‚’è¿½åŠ  */
			textarea { resize: vertical; min-height: 60px; } /* é«˜ã•ã‚‚èª¿æ•´å¯ */
			h3 { margin-top: 30px; }
			button { padding: 6px 12px; margin-top: 8px; }
			.hint { color:#666; font-size: 12px; }
		</style>
		<script>
			let configData, sheetHeaders = [];

			// åˆæœŸãƒ­ãƒ¼ãƒ‰
			function loadConfig() {
				google.script.run.withSuccessHandler(renderUI).getConfig();
			}

			// ç”»é¢æç”»
			function renderUI(payload) {
				const { config, headers } = payload;
				configData = config;
				sheetHeaders = headers;

				const target = config.targets?.[0] || {};
				renderComments(target);
				renderFilterBuilder(target);
			}

			// ===== â‘  diffDays / comments ãƒ†ãƒ¼ãƒ–ãƒ« =====
			function renderComments(target) {
				const comments = target.comments || {};
				const tbody = document.querySelector('#commentsTable tbody');
				tbody.innerHTML = '';
				// diffDaysï¼ˆæ•°å€¤ã®ã‚­ãƒ¼ï¼‰ã§æ˜‡é †ã«ä¸¦ã¹ã¦è¡¨ç¤º
				Object.keys(comments)
					.sort((a,b) => Number(a) - Number(b))
					.forEach(diff => addCommentRow(diff, comments[diff]));
			}

			function addCommentRow(diff = '', comment = '') {
				const tbody = document.querySelector('#commentsTable tbody');
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td style="width:160px">
						<input type="number" class="diffInput" value="${diff}" min="0" step="1" />
					</td>
					<td>
						<textarea class="commentInput" rows="3" placeholder="$name / $task ãŒä½¿ç”¨å¯èƒ½">${comment}</textarea>
					</td>
					<td style="width:84px">
						<button type="button" onclick="this.closest('tr').remove()">å‰Šé™¤</button>
					</td>
				`;
				tbody.appendChild(tr);
			}

			// ===== â‘¡ ãƒ•ã‚£ãƒ«ã‚¿ãƒ“ãƒ«ãƒ€ãƒ¼ï¼ˆANDã®ãƒ•ãƒ©ãƒƒãƒˆè¡Œï¼‰ =====
			// è¡¨ç¤ºã¯ã€ŒdiffDays ã‚’é™¤å¤–ã€ã—ã¦å‡ºã™ï¼ˆdiffDaysã¯commentsã‹ã‚‰è‡ªå‹•ç”Ÿæˆã™ã‚‹ãŸã‚ï¼‰
			function renderFilterBuilder(target) {
				const tbody = document.querySelector('#filterTable tbody');
				tbody.innerHTML = '';

				const andFilters = target.filters?.and || [];
				const visibleFilters = andFilters.filter(f => (f?.column || '').toString() !== 'diffDays');

				visibleFilters.forEach(f => addFilterRow(f.column, f.op, f.value));
			}

			function addFilterRow(column = '', op = '==', value = '') {
				const tbody = document.querySelector('#filterTable tbody');
				const tr = document.createElement('tr');
				const headerOptions = sheetHeaders
					.map(h => `<option value="${escapeHtml(h)}" ${h === column ? 'selected' : ''}>${escapeHtml(h)}</option>`)
					.join('');
				const valueStr = Array.isArray(value) ? value.join(',') : (value ?? '');

				tr.innerHTML = `
					<td style="width:260px">
						<select class="columnSelect">
							<option value="">(åˆ—ã‚’é¸æŠ)</option>
							${headerOptions}
						</select>
					</td>
					<td style="width:160px">
						<select class="opSelect">
							<option value="==">==</option>
							<option value="!=">!=</option>
							<option value="in">in</option>
							<option value="includes">includes</option>
							<option value=">">&gt;</option>
							<option value=">=">&gt;=</option>
							<option value="<">&lt;</option>
							<option value="<=">&lt;=</option>
						</select>
					</td>
					<td>
						<input type="text" class="valueInput" placeholder="å€¤ï¼ˆin ã®å ´åˆã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" value="${escapeHtml(valueStr)}" />
					</td>
					<td style="width:84px">
						<button type="button" onclick="this.closest('tr').remove()">å‰Šé™¤</button>
					</td>
				`;
				// op åˆæœŸå€¤
				tr.querySelector('.opSelect').value = op;
				// column åˆæœŸå€¤ï¼ˆç©ºã§ãªã‘ã‚Œã°åˆã‚ã›ã‚‹ï¼‰
				if (column) tr.querySelector('.columnSelect').value = column;

				tbody.appendChild(tr);
			}

			// ===== ä¿å­˜ =====
			function saveConfig() {
				// 1) comments ã‚’åé›†ï¼ˆdiffDaysã¨ãƒ†ãƒ³ãƒ—ãƒ¬ã®ãƒšã‚¢ï¼‰
				const newComments = {};
				document.querySelectorAll('#commentsTable tbody tr').forEach(row => {
					const diffRaw = row.querySelector('.diffInput').value.trim();
					const comment = row.querySelector('.commentInput').value.trim();
					if (diffRaw !== '' && comment !== '') {
						const n = Number(diffRaw);
						if (!Number.isNaN(n)) {
							newComments[String(n)] = comment;
						}
					}
				});

				// 2) diffDays ã‚’ comments ã®ã‚­ãƒ¼ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
				const diffDays = Object.keys(newComments)
					.map(k => Number(k))
					.filter(n => Number.isFinite(n))
					.sort((a,b) => a - b);

				// 3) ç”»é¢ã«è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ•ã‚£ãƒ«ã‚¿è¡Œã‚’åé›†ï¼ˆï¼diffDays ä»¥å¤–ï¼‰
				const otherFilters = [];
				document.querySelectorAll('#filterTable tbody tr').forEach(row => {
					const column = row.querySelector('.columnSelect').value.trim();
					const op = row.querySelector('.opSelect').value.trim();
					const valStr = row.querySelector('.valueInput').value.trim();
					if (!column || !op) return;

					let value;
					if (op === 'in') {
						value = valStr.split(',').map(s => s.trim()).filter(s => s.length > 0);
					} else {
						value = valStr;
					}
					otherFilters.push({ column, op, value });
				});

				// 4) filters.and ã‚’å†æ§‹ç¯‰ï¼ˆå…ˆé ­ã« diffDays ãƒ•ã‚£ãƒ«ã‚¿ã‚’ç¢ºå®Ÿã«å…¥ã‚Œã‚‹ï¼‰
				const andFilters = [];
				if (diffDays.length > 0) {
					andFilters.push({ column: 'diffDays', op: 'in', value: diffDays });
				}
				// æ—¢å­˜ã® diffDays ã¯å¿…ãšé™¤å»ã—ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã™ã‚‹
				for (const f of otherFilters) {
					if ((f.column || '') !== 'diffDays') andFilters.push(f);
				}

				// 5) configData ã«æ›¸ãæˆ»ã—
				const target = (configData.targets ||= [])[0] ||= {};
				target.comments = newComments;
				target.filters = { and: andFilters };

				// 6) ä¿å­˜
				google.script.run
					.withSuccessHandler(() => {
						alert('ä¿å­˜ã—ã¾ã—ãŸ');
						loadConfig(); // å†ãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ ç¢ºèª
					})
					.saveFullConfig(configData);
			}

			// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
			function escapeHtml(str) {
				return String(str).replace(/[&<>"']/g, s => ({
					'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
				}[s]));
}

			window.onload = loadConfig;
		</script>
	</head>

	<body>
		<h2>Slack ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®šã‚¨ãƒ‡ã‚£ã‚¿</h2>

		<h3>â‘  diffDays ã¨ ã‚³ãƒ¡ãƒ³ãƒˆè¨­å®š</h3>
		<p class="hint">diffDays ã‚’å¢—æ¸›ãƒ»å¤‰æ›´ã™ã‚‹ã¨ã€ä¿å­˜æ™‚ã«ã€ŒæœŸé™æ—¥ã¾ã§ã®æ—¥æ•°ã€ãƒ•ã‚£ãƒ«ã‚¿ãŒè‡ªå‹•ã§å†æ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚</p>
		<table id="commentsTable">
			<thead>
				<tr>
					<th style="width:160px">æœŸé™æ—¥ã¾ã§ã®æ—¥æ•° (diffDays)</th>
					<th>ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ$name / $task ãŒä½¿ç”¨å¯ï¼‰</th>
					<th style="width:84px"></th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
		<button type="button" onclick="addCommentRow()">â• è¡Œã‚’è¿½åŠ </button>

		<h3>â‘¡ ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ï¼ˆAND æ¡ä»¶ï¼‰</h3>
		<table id="filterTable">
			<thead>
				<tr>
					<th style="width:260px">åˆ—å</th>
					<th style="width:160px">æ¼”ç®—å­</th>
					<th>å€¤ï¼ˆ<code>in</code> ã®å ´åˆã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</th>
					<th style="width:84px"></th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
		<button type="button" onclick="addFilterRow()">â• æ¡ä»¶ã‚’è¿½åŠ </button>

		<hr />
		<button type="button" onclick="saveConfig()">ğŸ’¾ ä¿å­˜</button>
	</body>
</html>

